var __decorate=this&&this.__decorate||function(n,t,i,r){var f=arguments.length,u=f<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,i):r,e,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")u=Reflect.decorate(n,t,i,r);else for(o=n.length-1;o>=0;o--)(e=n[o])&&(u=(f<3?e(u):f>3?e(t,i,u):e(t,i))||u);return f>3&&u&&Object.defineProperty(t,i,u),u},__metadata=this&&this.__metadata||function(n,t){if(typeof Reflect=="object"&&typeof Reflect.metadata=="function")return Reflect.metadata(n,t)};System.amdDefine("@angular/websocket",["exports","@angular/core","rxjs/Rx","rxjs/Rx"],function(n,t,i,r){"use strict";var u=function(){function n(n,t,i){this.url=n;this.protocols=t;this.config=i;this.reconnectAttempts=0;this.sendQueue=[];this.onOpenCallbacks=[];this.onMessageCallbacks=[];this.onErrorCallbacks=[];this.onCloseCallbacks=[];this.readyStateConstants={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,RECONNECT_ABORTED:4};this.normalCloseCode=1e3;this.reconnectableStatusCodes=[4e3];var u=new RegExp("wss?://").test(n);if(!u)throw new Error("Invalid url provided");this.config=i||{initialTimeout:500,maxTimeout:3e5,reconnectIfNotNormalClose:!1};this.dataStream=new r.Subject}return n.prototype.connect=function(n){var i=this,t;n===void 0&&(n=!1);t=this;(n||!this.socket||this.socket.readyState!==this.readyStateConstants.OPEN)&&(t.socket=this.protocols?new WebSocket(this.url,this.protocols):new WebSocket(this.url),t.socket.onopen=function(n){i.onOpenHandler(n)},t.socket.onmessage=function(n){t.onMessageHandler(n);i.dataStream.next(n)},this.socket.onclose=function(n){t.onCloseHandler(n)},this.socket.onerror=function(n){t.onErrorHandler(n);i.dataStream.error(n)})},n.prototype.send=function(n){var t=this;return this.getReadyState()!==this.readyStateConstants.OPEN&&this.getReadyState()!==this.readyStateConstants.CONNECTING&&this.connect(),i.Observable.create(function(i){t.socket.readyState===t.readyStateConstants.RECONNECT_ABORTED?i.next("Socket connection has been closed"):(t.sendQueue.push({message:n}),t.fireQueue())})},n.prototype.getDataStream=function(){return this.dataStream},n.prototype.onOpenHandler=function(n){this.reconnectAttempts=0;this.notifyOpenCallbacks(n);this.fireQueue()},n.prototype.notifyOpenCallbacks=function(n){for(var t=0;t<this.onOpenCallbacks.length;t++)this.onOpenCallbacks[t].call(this,n)},n.prototype.fireQueue=function(){while(this.sendQueue.length&&this.socket.readyState===this.readyStateConstants.OPEN){var t=this.sendQueue.shift();this.socket.send(n.Helpers.isString(t.message)?t.message:JSON.stringify(t.message))}},n.prototype.notifyCloseCallbacks=function(n){for(var t=0;t<this.onCloseCallbacks.length;t++)this.onCloseCallbacks[t].call(this,n)},n.prototype.notifyErrorCallbacks=function(n){for(var t=0;t<this.onErrorCallbacks.length;t++)this.onErrorCallbacks[t].call(this,n)},n.prototype.onOpen=function(n){return this.onOpenCallbacks.push(n),this},n.prototype.onClose=function(n){return this.onCloseCallbacks.push(n),this},n.prototype.onError=function(n){return this.onErrorCallbacks.push(n),this},n.prototype.onMessage=function(t,i){if(!n.Helpers.isFunction(t))throw new Error("Callback must be a function");return this.onMessageCallbacks.push({fn:t,pattern:i?i.filter:undefined,autoApply:i?i.autoApply:!0}),this},n.prototype.onMessageHandler=function(n){for(var t=this,r,i=0;i<t.onMessageCallbacks.length;i++)r=t.onMessageCallbacks[i],r.fn.apply(t,[n])},n.prototype.onCloseHandler=function(n){this.notifyCloseCallbacks(n);this.config.reconnectIfNotNormalClose&&n.code!==this.normalCloseCode||this.reconnectableStatusCodes.indexOf(n.code)>-1?this.reconnect():this.dataStream.complete()},n.prototype.onErrorHandler=function(n){this.notifyErrorCallbacks(n)},n.prototype.reconnect=function(){this.close(!0);var n=this.getBackoffDelay(++this.reconnectAttempts);return setTimeout(this.connect(),n),this},n.prototype.close=function(n){return(n||!this.socket.bufferedAmount)&&this.socket.close(),this},n.prototype.getBackoffDelay=function(n){var t=Math.random()+1,i=this.config.initialTimeout,r=n,u=this.config.maxTimeout;return Math.floor(Math.min(t*i*Math.pow(2,r),u))},n.prototype.setInternalState=function(n){if(Math.floor(n)!==n||n<0||n>4)throw new Error("state must be an integer between 0 and 4, got: "+n);this.internalConnectionState=n},n.prototype.getReadyState=function(){return this.socket==null?-1:this.internalConnectionState||this.socket.readyState},n.Helpers=function(){function n(){}return n.isPresent=function(n){return n!==undefined&&n!==null},n.isString=function(n){return typeof n=="string"},n.isArray=function(n){return Array.isArray(n)},n.isFunction=function(n){return typeof n=="function"},n}(),n=__decorate([t.Injectable(),__metadata("design:paramtypes",[String,Array,Object])],n)}();n.$WebSocket=u});